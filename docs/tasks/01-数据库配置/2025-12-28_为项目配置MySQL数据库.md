# 为项目配置 MySQL 数据库 研究报告

## 研究日期

2025-12-28

## 研究问题

如何为当前项目（“心青年”智能体平台后端）配置 MySQL 数据库，并在数据库中建立 `users`（用户表）和 `knowledge_qa`（知识库问答表）？

## 发现摘要

- 项目当前默认使用 SQLite（`app/core/config.py` 的 `DB_URL`，见 L6）。
- 项目已用 SQLAlchemy（`app/db/session.py`）初始化同步 engine 与 `SessionLocal`，并提供 `init_db()` 来 create_all（见 `app/db/session.py`，L5-L6, L17-L22）。
- 目前 `app/models/__init__.py` 只定义了 `Base`，没有具体 ORM 模型（见 `app/models/__init__.py`，L1-L3）。
- `requirements.txt` 包含 `sqlalchemy` 与 `alembic`，但没有 MySQL 驱动（例如 `PyMySQL`）。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---:|---|
|`app/core/config.py`|当前项目配置，默认 DB_URL 为 SQLite|L1-L13（DB_URL 在 L6）|
|`app/db/session.py`|SQLAlchemy engine/session 创建、`get_db()`、`init_db()`|L1-L6、L9-L14、L17-L23|
|`app/models/__init__.py`|声明 `Base`（ORM 基类），当前无模型|L1-L3|
|`requirements.txt`|记录项目依赖（缺少 MySQL 驱动）|整文件|

## 当前实现分析

### 核心流程

1. 配置层：`app/core/config.py` 使用 Pydantic `Settings`，由 `.env` 覆盖（默认 `DB_URL = "sqlite:///./dev.db"`）。（见 `app/core/config.py`）
2. 连接层：`app/db/session.py` 用 `create_engine(settings.DB_URL, future=True)` 创建同步 engine，并用 `sessionmaker` 生成 `SessionLocal`。`get_db()` 以 generator 方式提供 DB session 到依赖注入。`init_db()` 通过 `Base.metadata.create_all(bind=engine)` 创建所有注册的表。（见 `app/db/session.py`）
3. 模型层：`app/models/__init__.py` 暂时仅导出 `Base`，具体表模型尚未实现，因此 `init_db()` 在目前项目上会跳过实际建表（因为没有模型被导入注册）。

### 关键代码片段

- `app/core/config.py`（关键行）

```python
class Settings(BaseSettings):
    APP_NAME: str = "心青年智能体平台 - Backend"
    DB_URL: str = "sqlite:///./dev.db"   # <-- L6
    VECTOR_STORE: str = "chroma"

    class Config:
        env_file = ".env"

settings = Settings()
```

- `app/db/session.py`（关键行）

```python
engine = create_engine(settings.DB_URL, future=True)  # <-- L5
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)  # <-- L6

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

def init_db():
    try:
        from app.models import Base
        Base.metadata.create_all(bind=engine)
    except Exception:
        pass
```

## 建议的数据库设计（ER 与字段）

说明：设计兼顾常见认证需求与知识问答的检索/版本管理需求。所有字符串列建议使用 `utf8mb4` 编码（MySQL）以支持 Emoji 与多字节字符。

1) `users` 表（用户）

- 字段：
  - `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT
  - `username` VARCHAR(150) NOT NULL UNIQUE
  - `email` VARCHAR(320) NULL UNIQUE
  - `password_hash` VARCHAR(255) NOT NULL
  - `full_name` VARCHAR(255) NULL
  - `is_active` TINYINT(1) NOT NULL DEFAULT 1
  - `is_superuser` TINYINT(1) NOT NULL DEFAULT 0
  - `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3)
  - `updated_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3)

2) `knowledge_qa` 表（知识问答）

- 字段：
  - `id` BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT
  - `question` TEXT NOT NULL
  - `answer` LONGTEXT NOT NULL
  - `source` VARCHAR(255) NULL   -- 来源或文档标识
  - `metadata` JSON NULL         -- 可存储额外字段（tag、source_url 等）
  - `vector_id` VARCHAR(128) NULL -- 若使用外部向量存储，这里做映射
  - `created_by` BIGINT NULL     -- FK -> users.id（可选）
  - `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3)
  - `updated_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3)

- 索引建议：
  - 在 `question` 上建全文索引（MySQL 8+: `FULLTEXT(question)`）用于快速关键词检索
  - 在 `vector_id` 建索引以便于向量检索结果映射

## 示例 SQL DDL（MySQL，utf8mb4）

```sql
CREATE TABLE `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(150) NOT NULL,
  `email` VARCHAR(320),
  `password_hash` VARCHAR(255) NOT NULL,
  `full_name` VARCHAR(255),
  `is_active` TINYINT(1) NOT NULL DEFAULT 1,
  `is_superuser` TINYINT(1) NOT NULL DEFAULT 0,
  `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  `updated_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_users_username` (`username`),
  UNIQUE KEY `ux_users_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE `knowledge_qa` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `question` TEXT NOT NULL,
  `answer` LONGTEXT NOT NULL,
  `source` VARCHAR(255),
  `metadata` JSON,
  `vector_id` VARCHAR(128),
  `created_by` BIGINT UNSIGNED,
  `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
  `updated_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3) ON UPDATE CURRENT_TIMESTAMP(3),
  PRIMARY KEY (`id`),
  KEY `ix_kq_vector_id` (`vector_id`(128)),
  KEY `ix_kq_created_by` (`created_by`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 可选：全文索引（取决于检索策略）
ALTER TABLE `knowledge_qa` ADD FULLTEXT INDEX `ft_kq_question` (`question`);
```

## 推荐的实现步骤（可直接在项目中落地）

1. 依赖：在 `requirements.txt` 中添加 MySQL 驱动。推荐使用 `PyMySQL`（纯 Python，易安装）：

```
PyMySQL>=1.0
```

2. 配置：将 `app/core/config.py` 的 `DB_URL` 修改为从环境变量读取 MySQL URL，示例 `.env`：

```
DB_URL=mysql+pymysql://<db_user>:<db_password>@<host>:<port>/<db_name>?charset=utf8mb4
```

示例将 `config.py` 保持 Pydantic `Settings` 不变，但在部署时通过 `.env` 或环境变量覆盖。

3. 修改 `app/db/session.py`（可选改进）：

- 对于生产环境推荐增加 `pool_pre_ping=True` 来处理断线重连问题；对于 PyMySQL 需要 `pool_size`、`max_overflow` 等按需配置。

示例：

```python
engine = create_engine(
    settings.DB_URL,
    future=True,
    pool_pre_ping=True,
)
```

4. 在 `app/models/` 下新增 ORM 模型文件：`user.py` 与 `knowledge.py`，并在 `app/models/__init__.py` 中 import 所有模型以便 `init_db()` 能注册 metadata。

示例 `app/models/user.py`（SQLAlchemy ORM，同步模式）：

```python
from sqlalchemy import Column, Integer, BigInteger, String, Boolean, DateTime
from sqlalchemy.sql import func
from app.models import Base

class User(Base):
    __tablename__ = "users"
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    username = Column(String(150), nullable=False, unique=True)
    email = Column(String(320), unique=True)
    password_hash = Column(String(255), nullable=False)
    full_name = Column(String(255))
    is_active = Column(Boolean, default=True)
    is_superuser = Column(Boolean, default=False)
    created_at = Column(DateTime(timezone=False), server_default=func.now())
    updated_at = Column(DateTime(timezone=False), server_default=func.now(), onupdate=func.now())
```

示例 `app/models/knowledge.py`：

```python
from sqlalchemy import Column, BigInteger, Text, String, JSON, DateTime, ForeignKey
from sqlalchemy.sql import func
from app.models import Base

class KnowledgeQA(Base):
    __tablename__ = "knowledge_qa"
    id = Column(BigInteger, primary_key=True, autoincrement=True)
    question = Column(Text, nullable=False)
    answer = Column(Text, nullable=False)
    source = Column(String(255))
    metadata = Column(JSON)
    vector_id = Column(String(128))
    created_by = Column(BigInteger, ForeignKey("users.id"))
    created_at = Column(DateTime(timezone=False), server_default=func.now())
    updated_at = Column(DateTime(timezone=False), server_default=func.now(), onupdate=func.now())
```

并在 `app/models/__init__.py` 中加入：

```python
from sqlalchemy.orm import declarative_base

Base = declarative_base()

# ensure models are imported so metadata is registered
from app.models.user import User
from app.models.knowledge import KnowledgeQA
```

5. 迁移策略：使用 Alembic（项目已包含 `alembic`）。

- 更新 `alembic.ini` 或 `env.py`，使其从 `app.core.config.settings.DB_URL` 或环境变量读取连接 URL（不要把密码写死在代码中）。
- 运行：

```
alembic revision --autogenerate -m "create users and knowledge_qa"
alembic upgrade head
```

6. 测试：在本地先用 Docker / 本地 MySQL 创建测试数据库，设置 `.env`，然后运行 `uvicorn app.main:app --reload`，调用 `init_db()`（或先运行 Alembic）确认表创建成功。

## 迁移与运维注意事项

- 连接池参数应根据部署规模配置（`pool_size`, `max_overflow`, `pool_recycle` 等）。
- 若考虑高并发与非阻塞 IO，优先考虑 SQLAlchemy 的 async + async driver（例如 `asyncmy` 或 `aiomysql`），但那会要求将当前同步 `SessionLocal` 迁移为 async 版本，改动范围较大。
- 敏感信息（DB 密码）应通过环境变量或机密管理服务（如 Kubernetes Secret）注入，避免写入 git。

## 潜在风险和边缘情况

- 如果直接把 SQLite 的 `DB_URL` 替换为 MySQL，需要处理数据迁移（如果已有数据）。
- MySQL 驱动选择：`mysqlclient` 性能好但需编译环境；`PyMySQL` 易安装但性能略低。部署平台（是否能编译 C 扩展）会影响选择。
- 若使用外部向量数据库（现有代码有 `VECTOR_STORE` 配置），请不要把大向量直接存入 `knowledge_qa` 表，建议用 `vector_id` 做映射。

## 开放问题（需要用户确认）

1. 计划使用哪种 MySQL 驱动？（`PyMySQL` / `mysqlclient` / `asyncmy` 等）
2. 是否需要异步 DB 驱动（async SQLAlchemy）以支持高并发？
3. 是否希望把向量数据也保存在 MySQL（不推荐）或继续使用外部向量存储（推荐）？
4. 是否已有生产 MySQL 实例的访问信息（host/port/db/user）或需要我给出 Docker Compose 示例？

## 参考资料

- `app/core/config.py`（项目）：`app/core/config.py` L1-L13
- `app/db/session.py`（项目）：`app/db/session.py` L1-L23
- `app/models/__init__.py`（项目）：`app/models/__init__.py` L1-L3
- SQLAlchemy 文档（连接字符串、create_engine）：https://docs.sqlalchemy.org/
- Alembic 文档（迁移）：https://alembic.sqlalchemy.org/

## 完成后

1. 文档已保存到：`0-prompts/tasks/01-数据库配置/2025-12-28_为项目配置MySQL数据库.md`
2. 核心发现摘要：项目当前使用 SQLite；已搭好同步 SQLAlchemy session 管道；需要添加 MySQL 驱动、实现 ORM 模型并使用 Alembic 做迁移。
3. 需要您确认的事项（在“开放问题”部分列出）以便我生成具体代码补丁和迁移脚本。
4. 注意：如果项目上下文占用过高（超过 60%），建议执行 `/clear`。
