# 分角色注册功能 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-16 | v1.0 | 初始设计 | 无 |

## 研究问题

如何实现分角色（患者家属、志愿者、专家、管理员、维护人员）注册功能？

## 发现摘要

- 平台需支持五类角色注册，且各角色注册流程、必填项、审核机制存在差异。
- 角色类型需在注册流程中显式选择，并写入用户表。
- 志愿者、专家注册需管理员审核，且需补充资料与资质证明。
- 管理员、维护人员注册应为受控流程（仅超级管理员可添加）。
- 需设计统一的用户表结构，支持角色扩展字段。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|docs/“心青年”智能体平台-功能文档.md|角色定义与注册流程需求|L1-L205|
|app/models/user.py|用户模型定义|待补充|
|app/schemas/user.py|注册请求体与响应体|待补充|
|app/services/user_service.py|注册业务逻辑|待补充|
|app/api/v1/routes/users.py|注册接口路由|待补充|

## 当前实现分析

### 角色定义与注册需求

根据功能文档，平台用户分为五类：
- 患者家属：可自助注册，注册后可直接使用核心功能。
- 志愿者：自助注册，需补充个人资料，注册后进入“待审核”状态，管理员审核通过后方可服务。
- 专家：自助注册，需上传资质证明，注册后进入“待审核”状态，管理员审核通过后方可服务。
- 管理员、维护人员：不开放自助注册，仅限超级管理员后台添加。

### 统一用户表设计建议
- 用户表需包含 `role` 字段（如 family, volunteer, expert, admin, maintainer）。
- 志愿者、专家需有 profile 扩展表，存储详细资料与审核状态。
- 需有 `is_verified` 字段标记审核通过状态。

### 注册流程核心流程

```
+-------------------+         +-------------------+         +-------------------+
|   用户提交注册    |  --->   |  选择角色/填写资料 |  --->   |   创建用户记录    |
+-------------------+         +-------------------+         +-------------------+
         |                                                         |
         |<-------------------接口返回注册结果-------------------->|
         |
         v
+-------------------+         +-------------------+
|  需审核的角色？   |---是--->|  状态=待审核      |
+-------------------+         +-------------------+
         |否
         v
+-------------------+
| 状态=已激活/可用  |
+-------------------+
```

- 管理员/维护人员注册入口应受限，仅超级管理员可操作。

### 关键代码片段（建议实现方向）

- 用户表：
  - role: Enum
  - is_verified: bool
  - profile_id: 外键（志愿者/专家）
- 注册接口：
  - POST /register
  - 请求体包含 role 字段及对应资料
  - 根据角色分流注册逻辑

## 架构洞察

- 采用统一注册入口+角色分流，便于后续扩展。
- 审核流程与资料补充建议用 profile 扩展表实现，避免主表冗余。
- 管理员、维护人员注册应有二次确认与权限校验。

## 潜在风险和边缘情况

- 恶意用户冒充专家/志愿者注册，需严格审核与资料校验。
- 角色切换风险：注册后角色不可随意变更，需后台审批。
- 管理员/维护人员入口泄露风险。

## 开放问题

- 管理员/维护人员注册是否允许邀请制？
- 角色扩展表字段需进一步细化。
- 是否支持多角色绑定（如专家兼志愿者）？

## 参考资料

- docs/“心青年”智能体平台-功能文档.md
- FastAPI 用户注册最佳实践

