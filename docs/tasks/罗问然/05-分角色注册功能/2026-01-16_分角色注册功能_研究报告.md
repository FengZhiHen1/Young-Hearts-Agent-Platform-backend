# 分角色注册功能 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-16 | v1.0 | 初始设计 | 无 |
| 2026-01-16 | v1.1 | 根据反馈重构：明确不允许邀请制、完善字段定义、确认支持多角色 | 用户反馈 |

## 研究问题

如何实现分角色（患者家属、志愿者、专家、管理员、维护人员）注册功能？

## 发现摘要

- **角色体系**：平台支持五类角色，按照设计文档 `roles` 字段采用数组结构，**支持多角色绑定**（如用户可同时为家属和志愿者）。
- **字段定义**：依据数据模型通过 `User` 主表配合 `VolunteerProfile` 和 `ExpertProfile` 扩展表存储数据。
- **注册限制**：管理员与维护人员**不允许**开放注册，亦**不允许**邀请制，仅限超级管理员后台创建。
- **审核机制**：志愿者与专家注册后进入 `pending` 状态，需管理员审核激活。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|数据模型定义参考|L6-L100|
|docs/“心青年”智能体平台-功能文档.md|角色功能描述|--|
|app/models/user.py|User 模型定义（需修改）|--|
|app/schemas/user.py|Pydantic 校验模型（需修改）|--|
|app/api/v1/routes/auth.py|注册接口路由|--|

## 当前实现分析

### 1. 数据库模型设计 (基于数据模型文档)

需严格遵循 `docs/“心青年”智能体平台-数据模型与 API 设计.md` 中的定义。

**User (基础用户表)**
- 核心字段：`id`, `username`, `gender`, `email`, `password_hash`, `nickname`, `avatar`, `roles` (ARRAY), `status`, `created_at`
- `roles` 枚举值：`['family', 'volunteer', 'expert', 'admin', 'maintainer']`
- `status` 枚举值：`['active', 'banned', 'pending_review']`

**VolunteerProfile (志愿者扩展)**
- 关联：`user_id` (FK -> User.id)
- **敏感字段**：`full_name` (真实姓名), `phone` (手机号) —— *仅管理员可见*
- 公开字段：`public_email`, `is_public_visible`, `service_hours`, `skills` (Array)
- 状态字段：`status` ('pending', 'approved', 'rejected'), `work_status` ('online', 'busy', 'offline')

**ExpertProfile (专家扩展)**
- 关联：`user_id` (FK -> User.id)
- 业务字段：`full_name`, `title` (职称), `organization` (机构), `qualifications` (Array<URL>), `specialties` (Array)
- 状态字段：`status` ('pending', 'approved', 'rejected')
- 敏感/其他：`phone`, `public_email`, `is_public_visible`

### 2. 注册流程逻辑

- **通用流程**：
  1. 接收注册请求。
  2. 验证基础信息（用户名/邮箱唯一性）。
  3. 创建 `User` 记录。

- **角色分流**：
  - **Type A: 家属 (Family)**
    - User 记录 `roles=['family']`, `status='active'`。
    - 无需额外 Profile 表。
  - **Type B: 志愿者 (Volunteer)**
    - 必填：`full_name`, `phone`, `skills`。
    - User 记录 `roles=['volunteer']`, `status='active'` (允许登录但功能受限)。
    - 创建 `VolunteerProfile`，状态 `status='pending'`。
  - **Type C: 专家 (Expert)**
    - 必填：`full_name`, `title`, `qualifications` 等。
    - User 记录 `roles=['expert']`, `status='active'`。
    - 创建 `ExpertProfile`，状态 `status='pending'`。

- **多角色处理**：
  - 注册接口主要负责**创建用户并赋予初始角色**。
  - 后续若需增加角色（如家属申请成为志愿者），应通过 `/api/users/apply-role` 接口处理，而非注册接口。

### 关键代码片段 (Schema 定义建议)

```python
# app/schemas/user.py

from pydantic import BaseModel, EmailStr, HttpUrl
from typing import List, Optional
from enum import Enum

class UserRole(str, Enum):
    FAMILY = "family"
    VOLUNTEER = "volunteer"
    EXPERT = "expert"

class VolunteerProfileCreate(BaseModel):
    full_name: str
    phone: str
    skills: List[str]
    public_email: Optional[EmailStr] = None
    is_public_visible: bool = False

class ExpertProfileCreate(BaseModel):
    full_name: str
    title: str
    organization: str
    qualifications: List[str] # URLs
    specialties: List[str]
    phone: str

class UserRegisterRequest(BaseModel):
    username: str
    email: EmailStr
    password: str
    nickname: str
    gender: Optional[str] = "hidden"
    role: UserRole = UserRole.FAMILY  # 初始角色
    
    # 角色特定数据 (Validation: if role==volunteer, volunteer_info required)
    volunteer_info: Optional[VolunteerProfileCreate] = None
    expert_info: Optional[ExpertProfileCreate] = None
```

## 架构洞察

- **事务一致性**：User 和 Profile 的创建必须包裹在同一个 DB Transaction 中。
- **角色鉴权**：系统鉴权逻辑需从检查 `user.role == 'admin'` 调整为 `admin in user.roles`，以支持多角色。
- **状态分离**：User 的 `status` 控制账号登录权限，Profile 的 `status` 控制该角色下的业务权限（如接单、排班）。

## 潜在风险和边缘情况

- **Profile 缺失**：已有用户数据若手动修改 `roles` 但未创建 Profile，可能导致逻辑报错。需确保通过 Service 层操作。
- **隐私泄漏**：API 返回用户信息时，必须严格区分 "Owner/Admin 查看" 和 "Public 查看" 的序列化模型（UserResponse vs UserPublic），防止手机号泄漏。

## 开放问题

(已根据反馈解决：明确不支持邀请制，支持多角色，字段已对齐)

## 下一步行动

1. 更新 SQLAlchemy Model (`User`, `VolunteerProfile`, `ExpertProfile`)。
2. 重构 Pydantic Schemas。
3. 实现 `register` 接口的服务逻辑。

## 参考资料

- docs/“心青年”智能体平台-功能文档.md
- FastAPI 用户注册最佳实践

