# 后端用户身份控制 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-14 | v1.0 | 初始计划 | 基于 v4.1 研究报告与澄清答复 |
| 2026-01-14 | v1.1 | Phase 1 session 表调整及文档补充 | session 表直接新建并同步数据模型文档 |

## 关联研究
[docs/tasks/02-后端用户身份控制/2026-01-14_后端用户身份控制_研究报告.md](docs/tasks/02-后端用户身份控制/2026-01-14_后端用户身份控制_研究报告.md)

## 功能概述
本计划旨在重构后端用户身份控制体系，实现基于 SessionID 的多端统一会话、权限与 context 注入机制，严格对齐《数据模型与 API 设计》与最新研究报告，支持多角色、会话持久化、接口权限矩阵与安全策略。

---


## Phase 1: 用户与会话数据模型重构

### 目标
- User/VolunteerProfile/ExpertProfile 三表字段对齐 API 设计
- 新建 session 表（直接新建，无需迁移），持久化 SessionID 及相关信息
- roles 字段英文数组，支持多角色
- session 表结构与字段说明同步至数据模型文档

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/models/user.py|更新|补全/调整用户主表与扩展表，新增 session 表|
|app/schemas/user.py|更新|Pydantic 模型字段对齐 API 设计|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|参考|新增“会话管理”章节，描述 session 表结构及字段|

### 具体变更
- User 表：补全/调整字段，roles 字段为 Array/String(JSON)
- 新建 Session 表（直接新建，无需迁移）：
	- 字段：session_id, user_id, created_at, expired_at, user_agent, ip
	- 字段说明：
		- session_id：会话唯一标识，字符串
		- user_id：关联用户ID
		- created_at：会话创建时间
		- expired_at：会话过期时间
		- user_agent：客户端信息
		- ip：登录 IP 地址
- VolunteerProfile/ExpertProfile 表字段对齐
- schemas 同步调整
- 在 docs/“心青年”智能体平台-数据模型与 API 设计.md 新增“会话管理”章节，补充 session 表结构与字段说明

### 成功标准
- 自动验证：表结构与 API 设计一致
- 手动验证：数据库可正常写入/查询 session 记录，数据模型文档同步

---

## Phase 2: 会话机制与 context 注入中间件

### 目标
- 登录成功生成唯一 SessionID，写入 session 表
- Web 端用 HttpOnly Cookie，App/API 端用 X-Session-ID Header
- context 注入自动识别 Cookie/Header，注入 current_user

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/services/auth.py|重构|会话生成、校验、context 注入逻辑|
|app/core/config.py|更新|安全相关配置（Cookie 策略）|

### 具体变更
- create_session_id(user)：生成 SessionID 并写入 session 表
- get_current_user_from_context(request)：自动识别 Cookie/Header，查 session 表，注入 user
- context 注入失败时抛 401

### 成功标准
- 自动验证：接口用例可通过多端会话校验
- 手动验证：Web、App 均可正常登录并获取用户信息

---

## Phase 3: 登录/登出/注册接口重构

### 目标
- 登录接口生成 SessionID，Web 端 Set-Cookie，App 端返回 session_id
- 登出接口清理 session 表与 Cookie/Header
- 注册接口对齐 API 设计

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/api/v1/routes/auth.py|重构|登录/登出/注册接口多端适配|
|app/services/auth.py|更新|登出逻辑，session 失效处理|

### 具体变更
- login：成功后写 session 表，Web 端 set_cookie，App 端返回 session_id
- logout：清理 session 表记录，清除 Cookie/Header
- register：字段与校验对齐 API 设计

### 成功标准
- 自动验证：登录/登出/注册接口测试通过
- 手动验证：多端会话生效与失效

---

## Phase 4: 权限校验与资源隔离

### 目标
- require_roles 装饰器，严格对齐 API 权限矩阵
- 敏感字段按角色脱敏/剔除

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/services/auth.py|新增/更新|require_roles 装饰器实现|
|app/api/v1/routes/users.py|更新|接口权限与字段脱敏|

### 具体变更
- require_roles(roles)：校验 current_user.roles
- 各接口加装饰器，敏感字段按角色处理

### 成功标准
- 自动验证：接口权限测试用例通过
- 手动验证：不同角色访问敏感接口效果正确

---

## Phase 5: 测试用例补全与验证

### 目标
- 覆盖多端登录、权限、会话失效等场景

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|tests/test_users.py|补全/重构|多端、权限、会话相关测试|
|tests/test_health.py|更新|如涉及鉴权健康检查，需适配|

### 具体变更
- 登录/登出/注册/权限/会话失效等测试

### 成功标准
- 自动验证：pytest 全部通过
- 手动验证：覆盖所有边界场景

---

## PR Commit Message 模板

feat(auth): 重构后端用户身份控制，支持多端 SessionID、权限矩阵与 context 注入

- 用户/会话数据模型与 session 表
- 会话生成、校验、context 注入
- 登录/登出/注册接口多端适配
- 权限装饰器与敏感字段处理
- 测试用例补全

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-14 | v1.0 | 初始计划 | 基于 v4.1 研究报告与澄清答复 |

---



