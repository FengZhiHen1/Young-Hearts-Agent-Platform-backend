# 前端无法连接后端 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始设计 | 无 |

## 研究问题

前端页面注册、登录等操作时，出现 404（Not Found）和 400（Bad Request）错误，无法正常连接后端接口。

## 发现摘要

1. 后端接口路径设计与 openapi.json 文档一致，主路由为 `/api/auth/register`、`/api/auth/login`、`/api/users/me`。
2. 404 错误多为路径不匹配或请求方法错误，400 错误多为参数校验失败或业务逻辑拦截。
3. 注册接口对管理员/维护人员角色有特殊拦截，部分字段缺失会导致 400。
4. 用户信息接口 `/api/auth/me` 实际未实现，正确路径应为 `/api/users/me`。
5. CORS 配置允许前端跨域访问，未发现跨域限制。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|app/main.py|后端入口，路由与 CORS 配置|L1-L40|
|app/api/v1/routes/auth.py|注册/登录/登出接口实现|L1-L102|
|app/api/v1/routes/users.py|用户信息相关接口|L1-L45|
|app/services/auth.py|鉴权与 session 管理|L1-L136|
|app/services/user_service.py|用户创建/查询/更新/删除|L1-L50|
|app/schemas/user.py|用户与 profile 数据结构|L1-L137|
|app/models/user.py|用户/志愿者/专家/会话表结构|L1-L65|
|app/core/config.py|配置项（CORS、session、DB）|L1-L40|
|openapi.json|API 文档与 schema|L1-L200|

## 当前实现分析

### 核心流程

```
前端注册请求 POST /api/auth/register
  → FastAPI 路由匹配 /api/auth/register
    → UserRegisterRequest 校验参数（roles、profile 信息）
      → 拦截 admin/maintainer 注册
      → user_service.create_user 创建主用户
      → 根据 roles 创建志愿者/专家 profile
      → db.commit()，返回 UserOut
  → 若参数缺失/角色不符/数据库异常，抛出 400

前端获取用户信息 GET /api/auth/me
  → 实际无此接口，404
  → 正确接口为 /api/users/me
```

### 关键代码片段

- 注册接口拦截与 profile 校验：
  - [app/api/v1/routes/auth.py](app/api/v1/routes/auth.py#L35-L102)
- 用户信息接口（正确路径）：
  - [app/api/v1/routes/users.py](app/api/v1/routes/users.py#L14-L23)
- CORS 配置：
  - [app/main.py](app/main.py#L21-L34)

## 架构洞察

- 路由分离：auth 负责注册/登录，users 负责用户信息，接口路径需前后端一致。
- 参数校验严格，profile 信息缺失会直接 400。
- 管理员/维护人员注册需后台操作，前端注册会被拦截。
- CORS 已允许指定前端地址跨域。

## 潜在风险和边缘情况

- 前端请求路径与后端实际实现不一致（如 /api/auth/me）。
- 注册时 roles 字段与 profile 信息不匹配，导致 400。
- 数据库异常或字段唯一性冲突（如用户名重复）也会 400。
- 志愿者/专家 profile 字段未补全，注册失败。

## 开放问题

- 前端是否已切换用户信息接口到 /api/users/me？
- 注册请求 roles 与 profile 信息是否完整？
- 是否有特殊角色注册需求？
- 400 报错时后端返回的 detail 信息能否在前端展示？

## 参考资料

- [openapi.json](openapi.json)
- [“心青年”智能体平台-数据模型与 API 设计.md](../“心青年”智能体平台-数据模型与 API 设计.md)

