# 登录返回数据结构 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-15 | v1.0 | 初始研究报告 | 新建 |

## 研究问题

研究后端“登录”接口（/auth/login）返回给前端的数据结构，涵盖 Web 与 App 两端的差异。

## 发现摘要

- Web 端登录成功后，后端通过 set_cookie 设置 session_id，响应体直接返回用户信息（UserOut）。
- App 端登录成功后，响应体为 {"user": 用户信息, "session_id": session_id}。
- 用户信息结构为 UserOut，包含 id、username、email、gender、nickname、avatar、roles、status 等字段。
- session_id 为后端生成的 32 位随机字符串。
- 未采用标准 OAuth2 Token 返回结构（Token），而是自定义 session_id 方案。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|app/api/v1/routes/auth.py|登录接口路由与响应结构|L1-L25|
|app/services/auth.py|登录逻辑与 session_id 生成|L55-L80|
|app/schemas/user.py|用户与 session、token 数据结构|L1-L20, L35-L55, L78-L86|

## 当前实现分析

### 路由层（app/api/v1/routes/auth.py）
- @router.post("/login", response_model=UserOut)
- Web 端：set_cookie("session_id", session_id)，返回 user（UserOut）
- App 端：返回 {"user": user, "session_id": session_id}

### 服务层（app/services/auth.py）
- login(user_in, request):
  - 校验用户名密码，失败抛 401
  - 生成 session_id，写入 session 表
  - 返回 user, session_id

### 数据结构（app/schemas/user.py）
- UserOut 继承 UserBase，字段有 id、username、email、gender、nickname、avatar、roles、status
- SessionBase 定义 session_id、user_id、created_at、expired_at、user_agent、ip
- Token 结构未被 /login 接口直接使用

### 核心流程

```
用户请求 /auth/login
    ↓
校验用户名密码
    ↓
生成 session_id，写入 session 表
    ↓
判断 user-agent
    ├─ Web：set_cookie("session_id"), 返回 user
    └─ App：返回 {"user": user, "session_id": session_id}
```

### 关键代码片段

- 路由层：app/api/v1/routes/auth.py L1-L25
- 服务层：app/services/auth.py L55-L80
- 数据结构：app/schemas/user.py L1-L20, L35-L55, L78-L86

## 架构洞察

- 采用 session_id 方案，兼容 Web Cookie 与 App 明文 session_id
- 用户信息结构统一，便于前后端解耦
- 未采用标准 OAuth2 Token 返回，后续如需对接第三方可考虑扩展

## 潜在风险和边缘情况

- session_id 泄露风险，App 端需安全存储
- Web/App user-agent 判断简单，可能误判
- 未返回 token_type，部分前端库可能不兼容

## 开放问题

- 是否考虑统一返回结构，兼容 OAuth2 标准？
- session 过期策略与刷新机制如何？
- 多端并发登录的 session 管理策略？

## 参考资料

- FastAPI 官方文档：https://fastapi.tiangolo.com/
- 项目内 app/schemas/user.py
- 项目内 app/api/v1/routes/auth.py
- 项目内 app/services/auth.py
