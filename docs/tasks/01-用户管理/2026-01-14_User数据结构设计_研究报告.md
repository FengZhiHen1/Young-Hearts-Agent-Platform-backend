# User数据结构设计 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-14 | v1.0 | 初始设计 | 参考功能文档梳理User结构 |

## 研究问题

如何根据“心青年”智能体平台功能文档，设计满足多角色、隐私合规、权限精细化的User数据结构？

## 发现摘要

- 平台需支持家属、志愿者、专家、管理员、维护人员五大角色，且角色可扩展。
- 用户表需包含基础信息、联系方式、认证与审核状态、隐私控制、角色与服务状态等字段。
- 需支持RBAC权限映射、资料公开与脱敏、注册与审核流、服务状态机等关键流程。
- 资料扩展建议采用Profile表分离敏感/可选信息，便于权限与隐私控制。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|docs/“心青年”智能体平台-功能文档.md|功能需求来源|全篇|
|app/models/user.py|User模型定义|待实现|
|app/schemas/user.py|User序列化/反序列化|待实现|

## 当前实现分析

### 字段建议

- id: 主键
- nickname: 昵称
- password_hash: 密码（加密存储）
- role: 角色（enum: family, volunteer, expert, admin, maintainer）
- is_verified: 是否通过审核
- is_active: 是否激活/可用
- is_public_visible: 资料是否对外公开
- email: 邮箱（可公开，受is_public_visible控制）
- mobile: 手机号（仅管理员可见）
- avatar_url: 头像
- created_at / updated_at: 时间戳
- service_status: 服务状态（enum: online, busy, offline, pending）
- profile_id: 外键，指向Profile扩展表

#### Profile扩展表建议
- user_id: 外键
- real_name: 真实姓名（可选/脱敏）
- expertise: 擅长领域（专家/志愿者）
- certificate_url: 资质证明（专家）
- introduction: 个人简介
- service_hours: 服务时长（志愿者）
- feedback_score: 反馈评分
- public_email: 公开邮箱（如与主邮箱分离）
- emergency_contact: 紧急联系方式（专家）
- ...可扩展

### 角色与状态机

- 角色（role）决定可见菜单、可操作按钮、可访问数据范围。
- is_verified 控制注册/审核流，未审核用户权限受限。
- service_status 控制志愿者/专家的任务分配与可见性。
- is_public_visible 控制是否出现在“专家/志愿者墙”及邮箱展示。

### 权限与RBAC映射

- 通过role字段与权限表/枚举映射，前后端均需实现。
- 需支持按钮级、数据级权限控制。

### 关键流程

1. 注册：填写基础信息，志愿者/专家需补充profile与资质，状态为pending。
2. 审核：管理员审核通过，is_verified=true，方可切换服务状态。
3. 资料公开：用户可设置is_public_visible，决定是否出现在公开列表。
4. 状态切换：志愿者/专家可切换online/busy/offline，影响任务分配。
5. 隐私控制：手机号仅管理员可见，邮箱仅is_public_visible=true时对外展示。

### 关键代码片段（建议）

```python
# app/models/user.py
class User(Base):
    id = Column(Integer, primary_key=True)
    username = Column(String, unique=True, nullable=False)
    password_hash = Column(String, nullable=False)
    role = Column(Enum('family', 'volunteer', 'expert', 'admin', 'maintainer'), nullable=False)
    is_verified = Column(Boolean, default=False)
    is_active = Column(Boolean, default=True)
    is_public_visible = Column(Boolean, default=False)
    email = Column(String, nullable=False)
    mobile = Column(String, nullable=False)
    avatar_url = Column(String)
    created_at = Column(DateTime)
    updated_at = Column(DateTime)
    service_status = Column(Enum('online', 'busy', 'offline', 'pending'), default='pending')
    profile_id = Column(Integer, ForeignKey('profile.id'))
    # ...

# app/models/profile.py
class Profile(Base):
    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, ForeignKey('user.id'))
    real_name = Column(String)
    expertise = Column(String)
    certificate_url = Column(String)
    introduction = Column(Text)
    service_hours = Column(Integer)
    feedback_score = Column(Float)
    public_email = Column(String)
    emergency_contact = Column(String)
    # ...
```

## 架构洞察

- 采用主表+扩展表模式，便于权限、隐私、角色扩展。
- 角色、状态、公开性等字段需与RBAC和前端动态路由/展示联动。
- 审核流、资料公开、脱敏等需后端中间件/前端协同实现。

## 潜在风险和边缘情况

- 角色变更后历史数据归属、权限同步问题。
- 资料公开与隐私冲突（如误公开手机号）。
- 字段冗余与扩展性平衡。
- 审核流与状态机复杂度提升。

## 开放问题

- 是否允许多角色绑定（如专家兼志愿者）？
- profile表字段是否需进一步细分（如分志愿者/专家profile）？
- 资料公开的默认策略与用户自主权边界？
- 合规性与数据脱敏细节需法务确认。

## 参考资料

- docs/“心青年”智能体平台-功能文档.md
- FastAPI/SQLAlchemy 用户模型最佳实践

