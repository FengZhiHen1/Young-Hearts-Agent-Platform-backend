# 用户数据模型与API参数一致性比对报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 首次输出比对报告 | 用户模型与API参数一致性分析 |

## 研究问题

对比《“心青年”智能体平台-数据模型与 API 设计.md》与实际 ORM（app/models/user.py）及 Pydantic schema（app/schemas/user.py），检查字段、类型、约束、API参数设计的一致性与差异。

## 发现摘要

- User、VolunteerProfile、ExpertProfile、Session 四大核心模型与文档设计基本一致，字段齐全，类型匹配。
- roles、skills 等数组字段在 ORM 层以 JSON 字符串存储，schema 层为 List 类型，需注意序列化/反序列化。
- profile 字段（如 full_name、phone）在 schema 层有脱敏与可选处理，符合文档安全要求。
- 部分字段命名、类型、默认值、约束有细微差异，建议统一。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|数据模型与API设计说明|L1-末尾|
|app/models/user.py|用户及扩展ORM模型|L1-80|
|app/schemas/user.py|用户相关Pydantic schema|L1-137|

## 当前实现分析

### 1. User 主表
- 文档字段：id, username, gender, email, password_hash, nickname, avatar, roles, status, created_at
- ORM实现：全部覆盖，roles为JSON字符串，status默认active，created_at/updated_at自动填充
- schema层：roles为List[UserRole]，status默认active，is_active/is_superuser为内部管理字段

### 2. VolunteerProfile/ExpertProfile
- 文档字段与ORM实现基本一致，skills为JSON字符串，status/work_status默认值匹配
- schema层 profile 字段为对象，敏感字段可选，service_hours等有默认值
- ExpertProfile中org字段与文档organization命名不一致，建议统一

### 3. Session
- 字段完全覆盖，类型一致，schema层有SessionBase/SessionOut等

### 4. 注册/输出API参数
- UserRegisterRequest 支持多角色注册，profile必填校验逻辑与文档一致
- UserOut 输出结构包含 volunteer_profile/expert_profile，字段齐全

## 核心流程

1. 注册时 roles、profile 参数校验与文档一致，缺失时报错
2. ORM 层 roles/skills 等需与 schema 层做序列化/反序列化
3. profile 敏感字段仅本人/管理员可见，schema 层已支持

## 关键代码片段

- User ORM: app/models/user.py L8-28
- VolunteerProfile ORM: app/models/user.py L31-44
- ExpertProfile ORM: app/models/user.py L47-59
- UserRegisterRequest: app/schemas/user.py L44-67
- UserOut: app/schemas/user.py L81-91

## 架构洞察

- roles、skills 等数组字段如后续需高效查询，建议考虑单独建表
- profile 拆分有助于权限与敏感信息隔离
- schema 层校验逻辑可防止前端参数缺失

## 潜在风险和边缘情况

- roles/skills 等字段序列化不一致可能导致数据异常
- profile 字段脱敏需在API层严格控制
- ExpertProfile 字段命名不统一（org/organization）

## 开放问题

- 其他业务模型（知识库、工单、排班等）未做本轮比对
- roles/skills 等字段如需频繁筛选，建议优化存储结构

## 参考资料

- docs/“心青年”智能体平台-数据模型与 API 设计.md
- app/models/user.py
- app/schemas/user.py
