# 分角色注册功能 实现计划

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-16 | v1.0 | 初始计划 | 基于 v1.1 研究报告 |

## 关联研究
docs/tasks/罗问然/05-分角色注册功能/2026-01-16_分角色注册功能_研究报告.md

## 功能概述
实现支持多角色（家属、志愿者、专家、管理员、维护人员）的注册功能。注册接口允许一次性注册多角色，志愿者/专家注册无需二次校验，注册成功后返回详细用户与 profile 信息。管理员/维护人员仅后台可创建。

---

## Phase 1: 数据模型与迁移脚本调整

### 目标
- User 表支持 roles（多角色）、status 字段
- 新增/完善 VolunteerProfile、ExpertProfile 表

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/models/user.py|更新|User、VolunteerProfile、ExpertProfile 模型|
|alembic/ |新增/更新|生成/调整数据库迁移脚本|

### 具体变更
- User.roles 字段改为 ARRAY/JSON，支持多角色
- User.status 字段支持 'active'、'banned'、'pending_review'
- VolunteerProfile/ExpertProfile 按研究报告字段定义

### 成功标准
- 自动验证：alembic upgrade 通过，表结构与 docs 对齐
- 手动验证：数据库表字段与文档一致

---

## Phase 2: Pydantic Schema 重构

### 目标
- 支持多角色注册与 profile 校验

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/schemas/user.py|更新|UserRegisterRequest、VolunteerProfileCreate、ExpertProfileCreate 等|

### 具体变更
- UserRegisterRequest 支持 roles: List[UserRole]
- volunteer_info/expert_info 支持多角色必填校验
- 输出 schema 支持详细 profile 信息

### 成功标准
- 自动验证：pytest 通过所有 schema 校验用例
- 手动验证：注册请求参数校验符合预期

---

## Phase 3: 注册接口服务逻辑实现

### 目标
- 注册接口支持多角色分流，事务一致性，返回详细信息

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|app/api/v1/routes/auth.py|更新|注册接口逻辑重构|
|app/services/user_service.py|更新|注册与 profile 创建服务|

### 具体变更
- 注册时根据 roles 创建 User 及对应 Profile，志愿者/专家 profile 状态为 pending
- 管理员/维护人员注册拦截
- 返回 User + profiles 详细信息
- 事务包裹所有写操作

### 成功标准
- 自动验证：pytest 注册相关用例通过
- 手动验证：注册多角色用户，profile 状态与数据正确

---

## Phase 4: 测试用例与文档

### 目标
- 覆盖多角色注册、profile 创建、异常分支

### 修改文件清单
|文件路径|修改类型|说明|
|---|---|---|
|tests/test_users.py|新增/更新|注册相关测试|
|docs/“心青年”智能体平台-数据模型与 API 设计.md|更新|接口/模型文档同步|

### 具体变更
- 新增多角色注册、profile 校验、权限拦截等测试
- 文档同步接口参数与返回结构

### 成功标准
- 自动验证：pytest 全部通过
- 手动验证：文档与实现一致

---

## Commit message 模板

feat: 分角色注册功能（多角色支持、profile 创建、详细返回）

- User/Volunteer/Expert 模型与 schema 重构
- 注册接口支持多角色与详细 profile 返回
- 完善测试与文档

---

## PR 描述要点
- 支持多角色注册与扩展 profile 创建
- 注册接口返回详细用户与 profile 信息
- 管理员/维护人员注册拦截
- 完善测试与文档

