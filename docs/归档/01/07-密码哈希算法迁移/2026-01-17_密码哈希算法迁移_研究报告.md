# 研究报告：将哈希算法从 bcrypt 迁移到 Argon2

## 1. 背景

目前项目使用 `passlib` 配合 `bcrypt` 算法进行密码哈希。`bcrypt` 是一种广泛使用的经典哈希算法，但它存在一个著名的限制：**明文密码长度不能超过 72 字节**。

在 [03-密码长度限制报错](../03-密码长度限制报错/2026-01-17_密码长度限制报错_研究报告.md) 任务中，我们确认了当用户输入的密码（或经前端处理后的密码）超过 72 字节时，`bcrypt` 会直接抛出异常，导致 500 错误或注册失败。

为了解决此问题，并提升系统的安全性和抗未来破解能力，计划将默认哈希算法迁移到 **Argon2**。

## 2. 为什么选择 Argon2

Argon2 是 2015 年密码哈希竞赛（PHC）的获胜者，是目前推荐的密码哈希标准。

### 2.1 优势
1.  **无长度限制**：Argon2 不受 72 字节限制，可以处理任意长度的密码。
2.  **抗 GPU/ASIC 攻击**：Argon2 是内存硬（Memory-hard）算法，攻击者难以利用并行硬件（如 GPU）进行大规模暴力破解。
3.  **可调参数**：可以灵活配置内存使用量、CPU 时间片和并行度，以适应不同的硬件环境和安全需求。
4.  **侧信道攻击抵抗**：Argon2i 变体专门针对侧信道攻击进行了优化（通常推荐使用 Argon2id，它是 Argon2i 和 Argon2d 的混合体，兼顾了抗侧信道和抗 GPU 破解）。

### 2.2 劣势
*   **计算成本**：比 bcrypt 消耗更多的内存和 CPU 资源（这正是其安全性来源，但在低配服务器上需要注意参数调优）。
*   **依赖库**：需要引入新的依赖 `argon2-cffi`。

## 3. 迁移策略

**更新（2026-01-17）：经确认项目当前没有存量用户，无需考虑平滑迁移方案，可以直接替换算法。**

### 3.1 核心配置
我们将 `CryptContext` 配置为仅使用 Argon2：
*   **默认方案（default scheme）**：`argon2`。
*   **废弃方案（deprecated）**：无需设置 `bcrypt` 为废弃，直接移除即可。

### 3.2 运行时行为
1.  **用户注册**：系统使用 `argon2` 生成哈希。
2.  **用户登录**：系统使用 `argon2` 验证哈希。

## 4. 实现步骤

### 4.1 依赖变更
在 `requirements.txt` 中添加 `argon2-cffi`。

### 4.2 代码修改
修改 `app/services/auth.py` 中的 `CryptContext` 初始化。

```python
# 修改前
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")

# 修改后
pwd_context = CryptContext(schemes=["argon2"], deprecated="auto")
```

### 4.3 验证逻辑
由于不需要平滑迁移，**无需**修改 `authenticate_user` 和 `login` 函数来添加 `needs_update` 检查和哈希自动升级逻辑。现有的 `verify_password` 逻辑可以直接工作。

## 5. 风险评估与测试

1.  **性能测试**：Argon2 默认参数可能在某些容器环境中导致内存突增。建议使用默认参数进行简单压测。
2.  **验证**：新注册用户应可以正常登录，且数据库中密码字段不再受 72 字节限制。

## 6. 结论

由于无存量用户，迁移方案极简：引入依赖并修改配置即可，无需编写额外的数据迁移代码。
