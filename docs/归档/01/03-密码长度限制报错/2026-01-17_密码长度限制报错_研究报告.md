# 密码长度限制报错 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-17 | v1.0 | 初始分析 | 新建任务 |

## 研究问题

为何按照如下请求提交注册，返回：
```
{"detail": "注册失败: password cannot be longer than 72 bytes, truncate manually if necessary (e.g. my_password[:72])"}
```
请求体示例：
```json
{
  "username": "123456",
  "password": "123456",
  "roles": ["family"],
  "gender": "hidden"
}
```

## 发现摘要

- 项目使用 passlib + bcrypt 进行密码加密，bcrypt 对明文密码有 72 字节长度限制。
- 注册流程未对密码长度做前置校验，超长密码会在 hash 阶段抛出异常。
- 只要 password 超过 72 字节（非字符），就会报该错误。
- 截图请求中的 password 长度为 6，理论不会触发此限制，需关注编码或参数传递异常。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|app/services/auth.py|密码加密与校验、注册服务|L8-40, L93-120|
|app/services/user_service.py|用户创建服务，调用密码加密|L1-40|
|app/schemas/user.py|注册请求体定义|L46-67|
|app/models/user.py|用户表结构，password_hash 字段|L8-20|
|app/api/v1/routes/auth.py|注册接口路由|L73-90|
|requirements.txt|依赖 bcrypt 说明|L10|

## 当前实现分析

- 注册接口 `/api/auth/register` 由 `app/api/v1/routes/auth.py` L73-90 定义，入参为 `UserRegisterRequest`。
- 业务逻辑在 `user_service.create_user`，实际加密由 `get_password_hash`（`app/services/auth.py` L27-28）完成。
- `get_password_hash` 使用 passlib 的 bcrypt 算法，bcrypt 明文密码最大支持 72 字节，超出会抛出异常。
- 用户表 `password_hash` 字段长度为 255，远大于 hash 后长度，不影响。
- 若 password 超长，passlib/bcrypt 会直接报错，未被 try-catch 包裹，最终返回注册失败。

### 核心流程

1. 前端提交注册请求（含 password 字段）
2. FastAPI 路由接收，参数校验通过
3. 调用 user_service.create_user，传入 password
4. get_password_hash(password) 执行 bcrypt hash
5. 若 password > 72 字节，bcrypt 抛出异常
6. 异常未被捕获，FastAPI 返回 400/422 错误

### 关键代码片段

- 密码加密：
  - app/services/auth.py
    ```python
    pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
    def get_password_hash(password: str) -> str:
        return pwd_context.hash(password)
    ```
- 用户创建：
  - app/services/user_service.py
    ```python
    user = User(
        ...
        password_hash=get_password_hash(user_in.password),
        ...
    )
    ```

## 架构洞察

- bcrypt 是业内常用安全加密算法，但明文密码有 72 字节限制。
- 前端/后端均应对密码长度做校验，避免后端抛出底层异常。
- 目前注册流程未对密码长度做前置校验，存在用户体验与安全隐患。

## 潜在风险和边缘情况

- 若前端未限制密码长度，用户可提交超长密码，导致注册失败。
- 若密码包含特殊字符或编码异常，实际字节数可能大于字符数。
- 其他依赖 bcrypt 的接口（如修改密码）同样受此限制。

## 开放问题

- 是否需要在注册/修改密码接口增加密码长度校验？
- 是否需要在前端同步限制密码长度？
- 是否有历史数据因超长密码导致异常？

## 参考资料

- [bcrypt 官方文档](https://pypi.org/project/bcrypt/)
- [passlib bcrypt 限制说明](https://passlib.readthedocs.io/en/stable/lib/passlib.hash.bcrypt.html#security-notes)
- [相关 issue 讨论](https://github.com/pyca/bcrypt/issues/35)
