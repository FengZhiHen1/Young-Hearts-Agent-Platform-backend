# 密码长度限制报错 研究报告

## 版本记录

| 日期 | 版本 | 修改内容 | 修改原因 |
|---|---|---|---|
| 2026-01-14 | v1.0 | 初始分析 | 用户注册/登录报错调查 |
| 2026-01-14 | v1.1 | 补充 mock/依赖注入/环境异常分析 | 深入排查测试污染与依赖环境 |

## 研究问题

运行 tests/test_users.py 时，所有注册/登录相关测试均报错：
ValueError: password cannot be longer than 72 bytes, truncate manually if necessary (e.g. my_password[:72])

## 发现摘要

- 项目使用 passlib + bcrypt 进行密码加密。
- bcrypt 算法对明文密码有 72 字节长度限制，超出部分会被截断或直接报错。
- 测试用例生成的密码长度未超限（如 testpass123），但实际报错表明某处传入了超长密码。
- 代码未对密码长度做前置校验，bcrypt/Passlib 在 hash 时直接抛出异常。

## 相关文件清单

|文件路径|作用说明|关键行号|
|---|---|---|
|app/services/auth.py|密码加密与校验逻辑，bcrypt上下文初始化|L17-L28|
|app/services/user_service.py|用户注册时调用 get_password_hash|L10-L16|
|app/models/user.py|用户表结构，存储 password_hash|L15|
|app/schemas/user.py|注册/登录 Pydantic 模型|L7-L29|
|tests/test_users.py|测试用例，注册/登录流程，无 mock/patch/fixture|全文件|
|requirements.txt|依赖声明，passlib==1.7.4，无 bcrypt 明确声明|L2|
|pyproject.toml|依赖声明，bcrypt>=5.0.0, passlib==1.7.4|L8-L11|
|app/core/config.py|读取.env，未见 PASSLIB/BCRYPT 相关环境变量|L21|

## 当前实现分析

- 密码加密：
  - 见 app/services/auth.py L17-L28
  - 使用 passlib.context.CryptContext(schemes=["bcrypt"])，即 bcrypt 算法。
  - get_password_hash(password: str) -> str 直接调用 pwd_context.hash(password)
- 用户注册：
  - 见 app/services/user_service.py L10-L16
  - create_user 时 password_hash=get_password_hash(user_in.password)
- 密码校验：
  - 见 app/services/auth.py L23-L24
  - verify_password(plain_password, hashed_password) -> pwd_context.verify(...)
- 测试用例：
  - tests/test_users.py 注册/登录均传入短密码（如 testpass123），理论不会超限。
- 依赖：
  - requirements.txt 明确 passlib==1.7.4，默认集成 bcrypt。
  - pyproject.toml 中 bcrypt 版本要求较宽松，可能导致行为不一致。

### 核心流程

1. 注册接口收到明文密码
2. get_password_hash 调用 passlib+bcrypt 进行加密
3. 若密码长度 > 72 字节，bcrypt 抛出 ValueError
4. 测试用例未超限，但报错表明实际传入了超长密码

### 关键代码片段

- app/services/auth.py

```python
pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)
```

- app/services/user_service.py

```python
user = User(
    ...
    password_hash=get_password_hash(user_in.password),
)
```

## mock/依赖注入/环境异常方向补充分析

### mock/依赖注入/测试污染排查
- tests/test_users.py 未使用 mock/patch/fixture，也无 conftest.py、全局 fixture 或 setup 污染 password 字段。
- 所有注册/登录测试均显式传入短密码 "testpass123"，未见被覆盖或污染。
- 未见依赖注入或全局变量影响 password 字段。

### 依赖包与环境变量排查
- requirements.txt 仅声明 passlib==1.7.4，未声明 bcrypt，pyproject.toml 声明 bcrypt>=5.0.0。
- 若仅用 requirements.txt 安装，bcrypt 可能由 passlib 间接拉取，版本不确定，存在环境不一致风险。
- 未发现 .env 文件，config.py 仅声明 env_file，未见 PASSLIB/BCRYPT 相关环境变量读取。
- app/services/auth.py 未对 passlib/bcrypt 进行特殊配置，未读取环境变量。
- 未见 PYTHONHASHSEED、PASSLIB_*, BCRYPT_* 等环境变量相关代码。

### 关键代码片段
- tests/test_users.py
```python
password = "testpass123"
register_user(username, password)
session_id, headers = login_user(username, password)
```
- pyproject.toml
```toml
dependencies = [
    "bcrypt>=5.0.0",
    "passlib==1.7.4",
]
```

## 架构洞察（补充）
- 测试环境未见 mock/patch/fixture 污染 password 字段，测试用例本身无异常。
- 依赖声明分散（requirements.txt/pyproject.toml），可能导致 bcrypt 版本不一致，建议统一依赖管理。
- 若依赖未锁定，pip 安装顺序或缓存可能导致 bcrypt 版本漂移，影响加密行为。
- 环境变量未见影响，但建议明确文档说明。

## 潜在风险和边缘情况（补充）
- 依赖未锁定或多处声明，可能导致测试/生产环境 bcrypt 版本不一致，进而引发兼容性问题。
- 若未来引入 mock/patch/fixture，需警惕对 password 字段的污染。

## 开放问题（补充）
- 是否需要在 CI/CD 或开发文档中强制统一依赖声明与锁定？
- 是否需补充 .env.example 并明确说明 PASSLIB/BCRYPT 相关环境变量？
- 是否需在 requirements.txt 明确声明 bcrypt 版本？

## 参考资料

- https://passlib.readthedocs.io/en/stable/lib/passlib.hash.bcrypt.html
- https://github.com/pyca/bcrypt/
- https://fastapi.tiangolo.com/tutorial/security/

