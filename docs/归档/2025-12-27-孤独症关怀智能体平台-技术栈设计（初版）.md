# 孤独症关怀智能体平台 技术栈设计文档

## 文档日期

2025-12-27

## 关联功能文档

`docs/2025-12-27-孤独症关怀智能体平台-功能文档.md`

## 项目约束条件

- 后端现有实现/期望使用：`FastAPI`（Python）
- 部署环境：优先云部署（可选私有化部署），需要支持容器化（Docker）与 Kubernetes
- 合规/隐私：涉及患者画像与多模态数据，需优先考虑最小化采集、本地优先与数据脱敏
- 目标节奏：MVP 优先在第一阶段快速交付“知识库问答 + 内容管理后台 + 常见场景指南 + 咨询工单”

## 技术栈概览

| 技术维度 | 选用技术（首选 / 备选） | 核心作用 |
|---------|------------------------|---------|
| 前端框架 | React + TypeScript + MUI（Ant Design 可选） | 管理后台与用户 Web 端 UI，快速构建高可用交互界面 |
| 后端语言/框架 | Python / FastAPI | 业务 API、鉴权、与模型/检索组件交互（项目已有 FastAPI） |
| 数据库（关系型） | PostgreSQL (+ pgvector) / 备选：MySQL | 存储用户、条目、工单、版本历史与结构化画像数据 |
| 向量存储 | pgvector（小规模 MVP） / Milvus 或 Weaviate（可扩展） | 存储文档向量用于 RAG 检索 |
| 全文检索 | PostgreSQL full-text / OpenSearch（推荐用于中大型） | 文本检索与证据片段定位 |
| 缓存/会话 | Redis | 缓存热点数据、会话管理与任务去重 |
| 消息队列/异步任务 | Celery + Redis / RabbitMQ（备选） | 后台任务（文档索引、媒体转码、定时任务） |
| 文件存储 | S3 兼容（MinIO 本地 / AWS S3 云） | 存储多媒体（训练视频、图片）与静态资源 |
| Embedding / LLM 接入 | OpenAI / Azure OpenAI / 本地 LLM（Llama2、MPT 等，自托管可通过 Hugging Face + Triton） | 生成答案、Embedding 计算。首选托管服务以加速 MVP，长期支持本地自托管。 |
| RAG 框架 | LangChain / LlamaIndex（任选其一） | 管理检索、检索结果拼接与生成流程 |
| 容器化 & 编排 | Docker / Kubernetes（K8s） | 生产部署、扩展与运维一致性 |
| CI/CD | GitHub Actions / GitLab CI | 自动化测试、镜像构建与部署 |
| 监控/日志 | Prometheus + Grafana / ELK / OpenTelemetry | 指标监控、日志聚合与告警 |

## 核心功能技术实现

### 功能模块：知识库问答（FAQ & 智能检索）

| 技术点 | 选用技术 | 选型理由 |
|-------|---------|---------|
| 文档存储与版本 | PostgreSQL（条目元数据） + S3（媒体） | 关系型数据库保证结构化查询与版本管理，媒体放对象存储节省 DB 空间 |
| 文本检索 | PostgreSQL full-text（MVP）/ OpenSearch（扩展） | MVP 简化依赖、后期可换为 OpenSearch 提升检索性能与高阶查询 |
| 证据片段定位 | 结合检索引擎返回片段 + 源条目 URL | 显示出处、便于专家复核与可追溯性 |
| 检索增强生成 | embeddings + 向量检索（pgvector/Milvus） + LLM（OpenAI 或自托管） | RAG 简化为：检索候选 -> 拼接证据 -> LLM 生成答案并标注来源 |

### 功能模块：专业内容管理后台

| 技术点 | 选用技术 | 选型理由 |
|-------|---------|---------|
| 前端管理界面 | React + TypeScript + MUI | 快速搭建表单、富文本编辑器和多媒体上传页面 |
| 鉴权与 RBAC | OAuth2 / JWT（FastAPI 内置支持） | 支持角色化（管理员/专家/审核员）并与 API 无缝集成 |
| 媒体处理 | 后台异步任务（Celery） + 转码服务（FFmpeg） | 视频/音频异步处理，避免阻塞请求，保证上传体验 |
| 审核流 | 状态机 + 审核日志（DB） | 记录版本、审核人、时间与变更说明 |

### 功能模块：常见场景指南与咨询工单

| 技术点 | 选用技术 | 选型理由 |
|-------|---------|---------|
| 工单后台 | PostgreSQL + FastAPI | 结构清晰、方便查询历史与转人工流程 |
| 通知 | 邮件 + 短信（第三方，如 SendGrid/Twilio） + 应用内通知（Redis/推送） | 及时提醒专家与用户处理工单 |

## 辅助功能技术实现（第二、三阶段要点）

- RAG：使用 LangChain/LlamaIndex 将检索器（向量+全文）与生成模型拼接，输出含证据的答案与置信度评分。
- 用户画像：PostgreSQL 建模（用户表 + 事件/干预记录表），长期可迁移至时序 DB（如 ClickHouse）以做大规模分析。
- 多模态：初期将图片/音频的处理与分析封装为独立微服务，使用开源模型（如 Whisper for ASR, 基于 Vision 模型的情绪估计），并严格本地化/匿名化处理。

## 技术依赖关系

- 前端依赖后端 API（FastAPI）与对象存储（S3）
- RAG 流程依赖：文本索引（全文/向量） -> 检索器 -> Embedding 服务 -> LLM 服务
- 异步任务依赖消息队列（Redis/Celery）用于媒体处理与索引更新
- 用户画像与工单数据存储在 PostgreSQL，热点数据/会话放 Redis 缓存

## 潜在风险与替代方案

| 技术选择 | 潜在风险 | 替代技术 | 替代理由 |
|---------|---------|---------|---------|
| OpenAI/Azure OpenAI（托管 LLM） | 成本随使用增长；隐私/合规限制 | 本地自托管 LLM（Llama2、MPT 等） | 当对数据合规或成本敏感时，迁移至自托管模型；但需更多运维资源 |
| pgvector | 小规模适用，扩展性有限 | Milvus / Weaviate | 项目数据量增长、检索性能与并发需求增高时切换 |
| PostgreSQL full-text | 对复杂检索支持有限 | OpenSearch / Elasticsearch | 当需要复杂语义搜索与高吞吐时采用搜索引擎 |
| Celery + Redis | 单点性能受限，任务可见性较弱 | RabbitMQ + Celery 或 Kafka | 需要更强的可靠性与可观测时考虑替换 |

## 部署建议与运维

- MVP：使用 Docker Compose 部署（Postgres + Redis + FastAPI + React 静态），向量存储使用 `pgvector` 插件以降低初期复杂度。
- 生产：Kubernetes + Horizontal Pod Autoscaler，使用外部对象存储（S3），监控 Prometheus+Grafana，日志使用 ELK 或 Loki。
- 数据备份：定期备份 PostgreSQL 与对象存储，敏感数据采用加密 at-rest 与访问审计。

## 开发与迭代路线建议

1. MVP（1-2 个月）：实现 `知识库问答` + `专业内容管理后台` + `常见场景指南` + `咨询工单`。
   - 使用 PostgreSQL + pgvector、FastAPI、React + TypeScript、Redis 缓存、S3 (MinIO) 存储。
2. 第二阶段（2-4 个月）：引入 RAG（向量索引/检索）、用户画像、人工接入流程。
   - 若检索需求增长，逐步替换为 Milvus + OpenSearch。
3. 第三阶段（长期）：多模态情绪感知、互动陪伴、长期效果追踪。

## 完成后

1. 文档保存路径：`docs/2025-12-27-孤独症关怀智能体平台-技术栈设计.md`
2. 核心技术选型简述：
   - 后端：`FastAPI`（现有），数据库 `PostgreSQL`（+pgvector），向量检索随规模升级为 `Milvus/Weaviate`，LLM 首选托管（OpenAI），长期支持自托管。
   - 前端：`React + TypeScript`，管理后台使用成熟 UI 库（MUI/Ant Design）。
   - 部署：`Docker` -> `Kubernetes`，监控 `Prometheus/Grafana`，对象存储 `S3`。
3. 提醒事项：请确认合规与隐私边界（多模态数据采集）、预估 RAG 调用成本以便选型 Embedding/LLM 服务。
4. 下一步建议：我可以执行下列任意一项（请选择）
   - 将 MVP 技术栈拆解为具体的 API 设计草案（FastAPI 路由、数据库模型、索引流程）。
   - 按照上述选型生成基础的 `requirements.txt` / `Dockerfile` 与最小可运行示例。
   - 帮你把文档提交到 Git（创建分支并提交）。
