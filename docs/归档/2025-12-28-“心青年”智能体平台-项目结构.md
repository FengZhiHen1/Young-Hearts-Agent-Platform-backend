# 心青年智能体平台 后端项目结构设计

## 设计日期

2025-12-28

## 关联技术栈

`docs/2025-12-27-“心青年”智能体平台-技术栈设计.md`

## 项目基本信息

- **项目名称**：心青年智能体平台
- **核心功能**：专家智能体问答（面向孤独症干预/护理/康复）、知识库可视化编辑与管理、RAG 检索增强生成、API 提供给前端（React/Taro）调用
- **预期规模**：中型（初始 MVP + 持续扩展知识库与检索能力）
- **开发团队规模**：7 人（1 名组长 + 6 名大一组员）

## 设计原则

- 与 FastAPI 与 Python 社区最佳实践保持一致（按功能组织、分层清晰）。
- 模块化与低耦合，高内聚：业务、数据访问、模型、API 路由明确分离。
- 易上手与教学友好：考虑组员多数为初学者，代码结构应清晰、注释充分、示例丰富。
- 可扩展性与可替换性：支持后续接入不同向量数据库、检索器或模型服务。
- 环境与部署友好：支持 `.env`、Docker、Alembic 数据库迁移、CI（可选）。

## 整体结构概览

```
project-root/
├── app/
│   ├── api/                 # 路由与接口层（按版本/功能分包）
│   ├── core/                # 启动、配置、依赖注入、事件处理
│   ├── models/              # ORM 模型（SQLAlchemy）
│   ├── schemas/             # Pydantic DTO（请求/响应）
│   ├── services/            # 业务逻辑（用例/服务层）
│   ├── db/                  # 数据库会话、迁移配置（alembic）
│   ├── knowledge/           # 知识库、RAG、向量存储抽象与实现
│   ├── utils/               # 工具函数、通用库
│   └── main.py              # FastAPI 应用入口
├── scripts/                 # 本地辅助脚本（初始化、导入知识等）
├── deployments/             # Docker、Kubernetes、CI 配置
├── tests/                   # 单元与集成测试
├── docs/                    # 设计/使用说明（含技术栈、接口文档链接）
├── requirements.txt
├── .env.example
├── .gitignore               # 忽略文件
└── README.md
```

## 详细目录说明

### 1. `app/`

- 作用：应用代码主目录，包含 API、业务逻辑、数据访问和启动配置。
- 子目录结构：

```
app/
├── api/
│   ├── v1/
│   │   ├── routes/
│   │   └── deps.py
│   └── v2/ (future)
├── core/
│   ├── config.py
│   ├── security.py
│   └── events.py
├── models/
├── schemas/
├── services/
├── db/
│   ├── session.py
│   └── init_db.py
├── knowledge/
│   ├── ingest.py
│   ├── retriever.py
│   ├── vectorstore/         # 各类向量存储实现（FAISS/Chroma/Weaviate/RedisVector）
│   └── rag_pipeline.py
├── utils/
└── main.py
```

- 关键文件说明：
  - `app/main.py`：FastAPI 应用入口，包含中间件、路由注册、生命周期事件。
  - `app/core/config.py`：集中读取 `ENV`、`.env`，并暴露配置对象。
  - `app/db/session.py`：SQLAlchemy session 与依赖注入（`get_db`）。
  - `app/knowledge/rag_pipeline.py`：RAG 流水线封装（检索、生成、答案融合、来源返回）。

### 2. `app/api/`

- 作用：HTTP 路由层，负责输入校验、权限、响应格式化。
- 组织建议：按版本（`v1`）和按功能（`kb`, `user`, `chat`, `admin`）子包划分。

```
app/api/v1/routes/
├── kb.py          # 知识库相关接口（上传/检索/状态）
├── chat.py        # 会话接口：接入 RAG，返回回答与来源
├── users.py       # 用户、权限（若需要）
└── health.py      # 健康检查
```

### 3. `app/services/`

- 作用：集中封装业务逻辑，不直接依赖 HTTP 框架。便于单元测试。
- 示例：`services/chat_service.py` 实现会话管理、上下文拼接、调用 `knowledge` 模块。

### 4. `app/knowledge/`

- 作用：实现知识库的导入、索引、检索与向量存储的抽象。
- 建议设计：
  - 抽象 `VectorStore` 接口（`add_documents`, `search`, `persist`, `load`），便于切换实现。
  - `ingest.py`：支持从文件、HTML、Markdown、数据库导入并做文本拆分、嵌入计算。
  - `retriever.py`：实现检索策略（dense retriever + sparse BM25 的组合可选）。
  - `rag_pipeline.py`：将检索结果与 LLM（本地或云端）组合，输出带来源的回答。

### 5. `app/models/` 与 `app/schemas/`

- `models/`：使用 SQLAlchemy 定义持久化实体（用户、上传记录、知识条目元数据等）。
- `schemas/`：使用 Pydantic 定义输入/输出模型，便于接口校验与文档生成。

### 6. `app/db/` 与迁移

- `db/session.py`：创建 `SessionLocal` 与依赖。
- 使用 `alembic/` 管理数据库迁移，保存在项目根或 `migrations/`。

### 7. `tests/`

- 作用：包含单元测试和关键集成测试。
- 建议结构：按模块（`tests/api`, `tests/services`, `tests/knowledge`）组织。

### 8. `deployments/`、`scripts/`

- `deployments/`：`Dockerfile`, `docker-compose.yml`, k8s manifests, CI 配置（GitHub Actions）示例。
- `scripts/`：初始化数据库、导入示例知识、批量索引脚本等。

## 特殊文件说明

| 文件名 | 作用 | 注意事项 |
|--------|------|----------|
| `requirements.txt` | 记录依赖 | 推荐固定主要库版本（FastAPI, SQLAlchemy, alembic, pydantic, uvicorn, httpx, 向量库） |
| `.env.example` | 环境变量示例 | 包含 DB_URL、VECTOR_STORE_TYPE、OPENAI_KEY（或内部模型的访问配置） |
| `.gitignore` | git 的忽略 | 忽略不必要的文件，避免上传敏感信息 |
| `alembic/` | 数据库迁移 | 初始迁移脚本需与 `models/` 保持一致 |

## 模块间依赖关系

- `api` -> `services` -> `knowledge` / `db` -> `models`
- `services` 可调用 `utils` 和 `core` 的配置与安全工具
- `knowledge` 独立于 HTTP 层，可被 `scripts` 直接调用（用于数据导入/重建索引）

## 扩展性考虑

- 向量存储：通过 `VectorStore` 抽象可切换实现（本地 FAISS、Chroma、Redis、云服务）。
- 检索策略插件化：支持多检索器组合（BM25 + dense）和检索重排序。
- 多模型支持：将 LLM 调用封装为 `model_client` 接口，便于替换或本地化部署。
- 多租户/多知识库：将知识库按命名空间隔离，支持不同机构/用户的私有知识库。

## 最佳实践说明

- 将业务逻辑从路由层抽出到 `services`，提高可测试性。
- 使用 Pydantic schema 明确 API contract，减少前后端对接错误。
- 在 `knowledge` 中保留来源（source）和置信度（score），回答时返回参考来源，便于临床场景审计。
- 小步提交与 CI：团队成员水平参差，建议通过模板 PR、代码审查与 CI 检查确保质量。

## 完成后

1. 文档保存路径：`docs/2025-12-28-心青年智能体平台-structure.md`
2. 核心特点概述：
   - 基于 FastAPI 的按功能组织结构，清晰分离路由/业务/数据/知识库。
   - 为 RAG 与向量检索保留独立且可替换的模块（便于后续扩展）。
   - 包含部署、迁移、测试与脚本目录，便于团队协作与扩展。
3. 我希望你的反馈：
   - **整体结构是否合理？**
   - **是否需要把知识库（RAG）拆成独立微服务？**
   - **是否有特定功能要优先支持（如用户认证、多租户、实时会话持久化）？**

如需，我可以：
- 基于本结构生成 `cookiecutter` 模板或项目脚手架（带 `pyproject.toml` / `requirements.txt` / `Dockerfile`）。
- 进一步细化某个子模块（如 `app/knowledge/` 的接口定义与示例实现）。
