# “心青年”智能体平台 后端项目结构设计

## 版本记录

| 日期 | 变更内容 | 关联技术栈/作者 |
|---|---|---|
| 2026-01-11 | 基于技术栈文档（RAG核心化、RBAC增强）更新后端结构设计 | docs/“心青年”智能体平台-技术栈设计.md |

## 项目基本信息

- **项目名称**：心青年智能体平台（Young Hearts Agent Platform）
- **适用端**：后端 API Service
- **开发语言/框架**：Python 3.10+ / FastAPI
- **核心技术栈**：
  - **LLM/RAG**：LangChain + ChromaDB + OpenAI Compatible API
  - **数据库**：MySQL 8.0 (业务数据) + Redis (缓存/队列)
  - **异步任务**：Celery
  - **部署**：Docker + Docker Compose
- **核心功能**：
  - RAG 智能问答（基于文档的语义检索）
  - 统一服务中心（工单、志愿者排班、专家审核）
  - 知识库管理（双写视窗：结构化+向量化）
  - 五级 RBAC 权限体系

## 整体结构概览

```bash
backend-root/
├── app/                     # 业务代码主目录
│   ├── api/                 # 接口路由层 (Controller)
│   │   ├── v1/              # V1 版本接口
│   │   └── deps.py          # 依赖注入 (鉴权/DB会话)
│   ├── core/                # 全局配置 (Config/Security)
│   ├── db/                  # 数据库连接与会话
│   ├── models/              # SQLAlchemy ORM 模型 (MySQL)
│   ├── schemas/             # Pydantic 数据模型 (DTO)
│   ├── services/            # 纯业务逻辑层 (Service)
│   ├── rag/                 # RAG 引擎核心模块 (LangChain)
│   ├── tasks/               # Celery 异步任务
│   ├── main.py              # FastAPI 应用入口
│   └── celery_worker.py     # Celery Worker 启动入口
├── alembic/                 # 数据库迁移脚本目录
├── deployments/             # 容器化部署配置
├── docs/                    # 项目文档
├── scripts/                 # 运维/初始化脚本
├── tests/                   # 测试用例
├── .env.example             # 环境变量模版
├── .gitignore               # Git 忽略配置
├── alembic.ini              # Alembic 配置文件
├── pyproject.toml           # 项目依赖与工具配置
└── requirements.txt         # 依赖列表 (兼容性导出)
```

## 详细目录说明

### 1. RAG 核心模块 (`app/rag/`) - **核心/新增**

> 对应技术栈：LangChain, ChromaDB, Embedding Models

该模块独立封装 LLM 与向量库交互逻辑，与普通业务逻辑解耦。

- `chains/`: 定义 LangChain 的处理链（如 `QAChain`, `RetrievalQA`）。
- `embeddings/`: 嵌入模型封装（适配 OpenAI/BGE 等模型）。
- `prompts/`: 集中管理 Prompt Templates（提示词模版）。
- `splitters/`: 文档切分策略（Character/Recursive/Markdown splitters）。
- `vectorstore/`: 向量数据库客户端封装（ChromaDB client, Collection 管理）。
- `service.py`: RAG 服务的统一入口，供 API 层调用（如 `rag_service.ask(query)`）。

### 2. 业务逻辑层 (`app/services/`)

> 对应技术栈：Python Business Logic

实现具体的业务规则，不直接依赖 HTTP 请求对象。

- `auth_service.py`: 登录认证、Token 签发。
- `user_service.py`: 用户注册、角色管理、审核逻辑。
- `ticket_service.py`: 工单创建、流转、状态更新。
- `shift_service.py`: 志愿者排班、报名、状态机（Redis 交互）。
- `knowledge_service.py`: 知识库文件的 CRUD，触发异步切片任务。

### 3. 接扣路由层 (`app/api/`)

> 对应技术栈：FastAPI APIRouter, Dependencies

- `deps.py`: **关键文件**。实现 `get_current_user`（鉴权）、`check_roles`（RBAC 权限检查）、`get_db`（数据库会话）。
- `v1/endpoints/`:
  - `auth.py`: 认证接口。
  - `users.py`: 用户管理接口。
  - `tickets.py`: 工单接口。
  - `schedules.py`: 排班与报名接口。
  - `chat.py`: 智能问答接口（调用 `rag_service`）。
  - `knowledge.py`: 知识库管理接口（上传/查询）。

### 4. 异步任务 (`app/tasks/`)

> 对应技术栈：Celery, Redis

- `worker.py`: Celery App 配置。
- `email_tasks.py`: 邮件通知任务（验证码、工单通知）。
- `knowledge_tasks.py`: 文档处理流水线（解析 -> 切片 -> 向量化 -> 入库）。

### 5. 数据模型 (`app/models/` & `app/schemas/`)

- `models/`: 定义数据库表结构（User, Ticket, Shift, KnowledgeMetadata）。
- `schemas/`: 定义 Pydantic 模型。
  - **Schema 分离原则**：针对不同角色定义不同 Schema（如 `UserResponse` vs `UserAdminResponse`），确保敏感字段（如手机号）对普通用户不可见。

## 特殊文件说明

| 文件名 | 作用 | 注意事项 |
|---|---|---|
| `app/core/config.py` | 加载环境变量 | 统一管理 `LLM_API_KEY`, `DB_URL` 等敏感信息，不要硬编码。 |
| `app/celery_worker.py` | Celery 启动入口 | 生产环境需单独启动 Worker 进程。 |
| `scripts/init_db.py` | 数据库/系统初始化 | 用于创建初始管理员账号或基础数据。 |
| `deployments/docker-compose.yml` | 本地编排文件 | 定义 API, Worker, MySQL, Redis, ChromaDB 服务关系。 |

## 模块间依赖关系

1.  **API -> Services**: API 层解析请求参数，调用 Service 层处理业务。
2.  **API -> Deps**: 路由依赖 `deps.py` 进行 Token 校验和权限拦截。
3.  **Services -> CRUD/Models**: Service 层操作数据库。
4.  **Services -> Tasks**: 耗时操作（如上传文档）Service 仅触发 Celery Task，不阻塞。
5.  **Tasks -> RAG**: 异步任务中调用 RAG 模块进行文档向量化。
6.  **RAG -> VectorStore**: RAG 模块直连向量数据库。

## 扩展性考虑

- **模型替换**：RAG 模块通过 LangChain 抽象，更换大模型只需修改配置和 `embeddings/` 下的适配器，业务代码无感。
- **微服务拆分**：当前结构模块清晰 (`rag`, `services`, `tasks`)。未来若需拆分，可直接将 `rag` 或 `tasks` 目录独立为微服务。
- **多租户/多机构**：在 `schemas` 和 `models` 中预留 `tenant_id` 或 `org_id`，并在 `deps.py` 中统一处理隔离逻辑。

## 最佳实践说明

- **配置分离**：所有配置项通过 `.env` 管理，禁止提交密钥到代码库。
- **RBAC 注入**：权限校验在 Router 层声明（`dependencies=[Depends(admin_required)]`），保证安全性。
- **API 版本化**：所有接口均在 `api/v1` 下，方便未来迭代 `v2`。
- **双写机制**：知识库元数据存 MySQL（便于管理和列表展示），文本内容存向量库（便于语义搜索）。

