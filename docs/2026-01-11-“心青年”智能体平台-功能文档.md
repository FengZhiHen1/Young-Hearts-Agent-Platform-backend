# “心青年”智能体平台 功能文档

## 版本记录
| 日期 | 修改类型 | 修改摘要 |
|---|---|---|
| 2025-12-27 | 新建 | 初始版本创建（MVP 聚焦基础检索与工单） |
| 2026-01-11 | 更新 | **核心重构**：<br>1. 将 RAG（检索增强生成）提升为第一阶段核心咨询引擎；<br>2. 架构调整：将知识录入、志愿者管理等后台功能整合为模块化的“统一服务中心”。 |
| 2026-01-11 | 更新 | 补充志愿者全流程管理：招募、排班、服务记录、服务状态与联系方式。 |
| 2026-01-11 | 更新 | 补充知识库录入两方案：初期人工录入表单与后期自动化解析/切片管道。 |
| 2026-01-11 | 更新 | **RBAC 体系细化**：<br>1. 明确患者家属、志愿者、专家、管理员、维护人员五大角色职责；<br>2. 重构子模块 C（系统管理），细化权限矩阵；<br>3. 调整知识库与志愿者模块以适配新角色流程。 |

## 文档日期
2026-01-11

## 项目目的
构建一个基于**RAG（检索增强生成）技术**的专业咨询平台，旨在解决孤独症家庭面临的“专业知识获取难”与“个性化建议匮乏”问题。
平台核心目标：
1. **智能咨询（核心）**：通过大模型与专业知识库结合，提供7x24小时、有权威依据的问答服务。
2. **统一服务（支撑）**：将分散的运营功能（知识录入、志愿者协作）模块化，形成一站式服务中心，降低维护门槛。

## 目标用户与角色
- **患者家属（核心用户）**：使用 RAG 智能咨询获取建议；当 AI 无法解决时发布人工咨询工单。
- **志愿者**：负责上传知识库作为草稿；在任务看板认领或接收管理员指派的工单进行解答。
- **专家**：负责知识库的高质量内容产出与审核（把关人）；在紧急情况下提供专业支持。
- **管理员**：负责志愿者的人员准入（注册审核）与任务的宏观调度。
- **维护人员**：负责系统后台记录审查与技术运维。

---

## 功能阶段规划表

| 阶段 | 功能模块 | 优先级 | 研发复杂度 |
|---|---|---|---|
| **第一阶段 (MVP)** | **RAG 智能咨询引擎（知识库问答）** | **P0** | **高** |
| **第一阶段 (MVP)** | **统一服务中心（模块化工作台）** | **P0** | 中 |
| 第一阶段 (MVP) | 基础用户认证与鉴权 | P1 | 低 |
| 第二阶段 | 用户/患者画像与个性化记忆 | P1 | 中 |
| 第三阶段 | 多模态交互（语音/视频情绪识别） | P2 | 高 |

---

## 第一阶段功能详情（核心交付）

### 1. RAG 智能咨询引擎（核心功能）
**需求概述**：
改变传统的关键词搜索模式，利用向量检索（Vector Search）配合 LLM，理解用户模糊、口语化的提问，基于专业知识库生成准确、有同理心的回答，并严格标注来源。

**用户场景 (User Story)**：
> 家长在深夜遇到孩子突发刻板行为，焦虑地输入一段长语音转换的文字：“孩子一直撞墙如果不让他撞他就尖叫怎么办？”
> 系统利用 RAG 技术，检索知识库中关于“自伤行为”与“刻板行为阻断”的专业条目，生成一份包含“即时安全干预”、“情绪安抚话术”和“后续就医标准”的结构化建议，并附带引用的专家文章链接。

**验收标准**：
1. **准确性**：基于测试集的回答，专业人员认可度 ≥ 85%，且无严重幻觉（胡乱编造医疗建议）。
2. **可溯源**：所有回答必须在末尾附带参考的知识库文档名称或链接（“来源：XXX康复指南 第3章”）。
3. **响应速度**：从提问到开始生成回答（TTFT）不超过 5 秒。
4. **兜底机制**：当知识库无相关内容时，明确告知“暂无准确参考”，引导转人工/志愿者。

**技术/数据依赖**：
- 向量数据库（Milvus/Chroma/PGVector）。
- 嵌入模型（Embedding Model）与生成模型（LLM）。
- 经过清洗和切片的专业文档库（Markdown/PDF）。

---

### 2. 统一服务中心（模块化收纳）
**需求概述**：
摒弃散乱的后台页面，构建一个统一的“服务中心”入口。用户（管理员/志愿者/专家）登录后，根据权限展示不同的功能“卡片”或“模块”。

#### 子模块 A：知识库管理模块

为适应项目分阶段交付需求，知识库管理模块提供两种可选实现方案（初期/后期），供项目在不同阶段采用。

方案 1 — 初期（简单、快速上线）
- **需求概述**：提供前端表单界面，运营/专家通过表单人工录入或粘贴文档片段，并手动将内容分割为结构化条目（title, summary, steps[], tags, age_range, references[]）。适用于冷启动阶段的数据建立与小规模内容管理。
- **用户场景**：**志愿者**整理了一篇康复文章，通过“上传材料”填写入库申请，状态为“待审核”；**专家**登录后台，查看“待审核”列表，校验内容准确性后点击“通过”，内容正式进入检索库。
- **验收标准**：
  1. 前端表单能创建包含必填字段（title, summary, steps, tags）的条目；
  2. 新建条目经审核后可被检索接口返回（`GET /api/v1/knowledge/search?q=...`）；
  3. 管理员能手动编辑条目及其元数据，并在界面查看原始来源链接。
- **依赖项**：表单 UI、知识条目数据库表、人工审核工作流；人工内容编辑者作为数据输入源。
- **估算工时**：S（小） — 主要工作为 CRUD 接口与前端表单、审核流。

方案 2 — 后期（自动化、规模化）
- **需求概述**：实现自动化的解析/清洗/切片与向量化管道。用户上传原始文档（PDF/Word/图片），系统自动执行 OCR（如需）、文本提取、分块（chunking）、元数据抽取、向量化并入库；同时提供切片预览与人工校正界面。
- **用户场景**：**专家**上传一份 30 页的专家指南，系统自动完成文档切片与向量入库，**专家**在“切片编辑”界面校正或合并切片并触发发布，切片即成为 RAG 检索单元。
- **验收标准**：
  1. 上传文档后，后台任务在合理时长内（例如 5 分钟内，视文档大小）完成切片并生成向量索引；
  2. 自动生成的切片包含来源引用与页码/片段位置；内容审核员能在 UI 上对任一切片进行修改并重新索引；
  3. 自动化入库的切片在检索测试集上达到预设覆盖率（示例：常见问题检索命中率 ≥ 80%）。
- **依赖项**：OCR/解析库（如 Tesseract / pdfplumber / tika）、文本切片策略、嵌入模型以及向量数据库（Milvus/Chroma/PGVector）、后台任务队列（Celery/RQ）和切片编辑 UI。
- **估算工时**：L（大） — 包含解析器集成、并发任务处理、质量控制与管理员校正界面。

-- **迁移与兼容**：两种方案应共存：初期手动录入的数据直接进入相同的知识表结构；后期自动化入库需要能与既有手动条目合并并支持重复检测/去重策略。

-- **安全与合规**：对上传文档进行敏感信息检测（PII），在必要时自动脱敏或标记为需人工复核。

#### 子模块 B：志愿者管理模块
- **功能**：
  - **招募与审核**：志愿者注册需填写详细资料（含联系方式），提交后状态为“待审核”。**管理员**负责审核注册请求。
  - **服务状态管理**：
    - **在线**：进入工作状态，可以接受任务。
    - **忙碌**：手中已有任务，系统不再派发新任务。
    - **离线**：不在服务时间内。
    - **待审核**：注册未通过，权限受限。
  - **任务看板与分配**：
    - **主动申请**：**志愿者**在看板查看待处理工单列表，主动认领。
    - **被动分配**：**管理员**可将任务直接指派给“在线”且空闲的志愿者。
  - **服务记录与报表**：每次志愿服务自动生成服务记录（包含工单ID、志愿者ID、开始/结束时间、服务时长、处理结论、评分与备注），支持按时间/志愿者导出 CSV/Excel 报表。

- **验收标准**：
  1. “待审核”状态的志愿者登录后仅能查看状态提示，无法访问任务看板。
  2. 志愿者接手任务后，状态自动流转为“忙碌”；完成后可切回“在线”。
  3. 管理员在派单时，下拉列表仅展示“在线”且无积压任务的志愿者。
  4. 志愿者联系方式仅对**管理员**及授权的**专家**可见，前台严格脱敏。

- **依赖项**：
  - 用户/志愿者表（需扩展字段：资质文档、联系方式、状态 ENUM、可用时段）。
  - 工单系统接口（ticket API）。

- **估算工时**：M（中等） — 涉及状态机、任务分发逻辑与权限隔离。

#### 子模块 C：系统管理与权限控制模块
- **需求概述**：
  构建精细化的 RBAC（基于角色的访问控制）模型，确保不同角色（患者家属、志愿者、专家、管理员、维护人员）仅能访问其职责范围内的资源。

- **角色权限矩阵**：

| 角色 | 核心权限描述 | 数据访问范围 |
|---|---|---|
| **患者家属** | 1. 使用 RAG 问答<br>2. 提交咨询工单<br>3. 查看本人咨询工单历史 | 仅限本人数据 |
| **志愿者** | 1. **知识库**：上传材料（仅提交，不可审核）<br>2. **个人**：注册/完善资料（含联系方式），切换服务状态（在线/忙碌/离线）<br>3. **任务**：查看任务看板，主动认领或被指派任务 | 自己的任务与资料<br>仅限所认领任务的详情 |
| **专家** | 1. **知识库**：上传材料、**审核**他人提交的材料（通过/驳回）<br>2. **协作**：完善个人资料（紧急联系方式） | 知识库全量数据<br>被授权的紧急个案 |
| **管理员** | 1. **人员**：审核志愿者注册，查看志愿者/专家详情<br>2. **任务**：向“在线”志愿者强制派单<br>3. **统计**：查看全平台运营记录 | 全平台用户与业务数据 |
| **维护人员** | 1. **运维**：查看后端程序日志（Error/Access Log）<br>2. **监控**：系统运行健康度监控 | 系统日志与性能指标<br>无权查看用户敏感隐私 |

- **验收标准**：
  1. **菜单隔离**：志愿者登录看不到“知识库审核”入口；家属登录无后台入口。
  2. **按钮级控制**：志愿者上传材料页面无“发布”按钮，只有“提交审核”按钮。
  3. **数据安全**：维护人员查看日志时，日志中的用户手机号/姓名应通过中间件自动脱敏（如 `138****0000`）。
  4. **流程验证**：
     - 家属提工单 -> 志愿者（在线）在看板看到 -> 认领 -> 完结。
     - 志愿者注册 -> 管理员审核通过 -> 志愿者状态变更为“离线”（可切换为在线）。

- **估算工时**：M（中） — 涉及后端权限中间件（Middleware）、角色鉴权守卫（Guard）及前端动态路由设计。

---

## 风险与缓解

| 风险描述 | 影响范围 | 缓解建议 |
|---|---|---|
| **RAG 幻觉风险** | 智能咨询 | 1. 调整 Prompt 严格限制基于上下文回答；<br>2. 设置置信度阈值，低分回答强制转人工或显示警告；<br>3. 并在UI显著位置标注“AI建议仅供参考，医疗决策请遵医嘱”。 |
| **知识库质量参差** | RAG 效果 | 这里的瓶颈通常不在技术而在数据。需建立严格的“知识录入-审核-发布”流程，确保进入向量库的数据是干净且权威的。 |
| **算力成本** | 项目预算 | 初期使用轻量级开源模型或按 Token 计费的商业 API，避免部署昂贵的私有化大模型集群。 |

## 待用户确认的问题
1. **数据源现状**：目前手头是否有现成的、结构化的 PDF/Word 文档作为知识库冷启动数据？（决定了 RAG 的初期效果）。
2. **志愿者流程**：志愿者介入是仅限于“回答问题”，还是需要具备“线下支援”的能力？（影响管理模块的字段设计）。
3. **合规性**：医疗类建议的免责声明具体措辞是否需要法务审核？
